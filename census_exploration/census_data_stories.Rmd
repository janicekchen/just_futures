---
title: "Census Data Stories"
author: "Atlas of Essential Work"
date: "10/21/2021"
output: 
    tufte::tufte_html: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE)
library(tidycensus) # for collecting census data
library(tigris) # census geometries
library(tidyverse) # data wrangling
library(sf) # geocomputation 
library(mapdeck) # mapping in mapbox
library(colourvalues) # for color palettes
library(htmlwidgets)

# source("census_exploration/r_scripts/00_JF_Library.R")

mb_token <- "pk.eyJ1IjoiamFuaWNla2NoZW4iLCJhIjoiY2p3bnM0cWhxMGRoazN5cGw1dTV3Ymd5NCJ9.8lUlOe5D3txI8QgZXx19dw"
```


## Population Change in the Pacific Northwest
```{r population_data, include = FALSE}

# reading data
pop <- read.csv("data/raw/population_race_1820_1990.csv")
pop[pop$state == "oregon", "state"] <- "Oregon"
pop[pop$state == "washington", "state"] <- "Washington"
pop[pop$state == "idaho", "state"] <- "Idaho"
pop_therest <- read.csv("data/raw/population_change_1910to2020.csv") %>% 
  pivot_longer(cols = c(2:13), names_to = "year") # has data from 1990 to 2020

pop_therest$year <- gsub("X", "", pop_therest$year) %>%
  as.integer()

pop_therest <- pop_therest %>%
  filter(year > 1990)

names(pop_therest) <- names(pop[1:3])
pop_all <- rbind(pop[1:3], pop_therest) # all years

# aggregating population across all states just for fun (i.e. for later use)
pop_agg <- pop_all %>%
  group_by(year) %>%
  summarise(total_pop = sum(total_pop, na.rm = TRUE)) 

pop_agg$year <- as.integer(pop_agg$year) 

pop_change <- ggplot(data = pop_all) +
  geom_line(mapping = aes(x = year, y = total_pop, color = state)) +
  theme_minimal() +
  scale_y_continuous(labels = scales::comma) +
  ggtitle("Total Population Change in the PNW, 1820 - 2020") +
  xlab(NULL) +
  ylab(NULL)
  

#chart 2: all state race
# aggregating data by race to visualize race change across the PNW
pop_tidy <- pop %>% # making data tidy first
  select(-total_pop) %>%
  pivot_longer(cols = c(3:8), names_to = "race")

# renaming race variables for visualization 
pop_tidy[pop_tidy$race == "ai", "race"] <- "American Indian"
pop_tidy[pop_tidy$race == "white", "race"] <- "White"
pop_tidy[pop_tidy$race == "black", "race"] <- "Black"
pop_tidy[pop_tidy$race == "api", "race"] <- "Asian / Pacific Islander"
pop_tidy[pop_tidy$race == "hispanic", "race"] <- "Hispanic / Latinx"
pop_tidy[pop_tidy$race == "other", "race"] <- "Other"

race_agg <- pop_tidy %>%
  group_by(race, year) %>%
  summarise(value = sum(value, na.rm = TRUE))

race_agg[race_agg == 0] <- NA

# adding percentage change column
race_agg <- race_agg %>%
  group_by(race) %>%
  arrange(year, .by_group = TRUE) %>%
  mutate(pct_change = (value/lag(value) - 1) * 100) %>%
  left_join(pop_agg, by = "year") %>% # joining total population values 
  mutate(normed = (value / total_pop) * 100)

race_no_white <- race_agg %>% 
  filter(race != "White")
  
race_change <- ggplot(data = race_no_white) +
  geom_line(mapping = aes(x = year, y = normed, color = race)) +
  geom_point(mapping = aes(x = year, y = normed, color = race), na.rm = FALSE) +
  theme_minimal() +
  scale_y_continuous(labels = scales::comma) +
  ggtitle("Total Population Change by Race, 1820 - 1990") +
  xlab(NULL) +
  ylab(NULL)


# chart3: faceted race by state
pop_tidy <- pop_tidy %>%
  left_join(pop_all) %>%
  mutate(normed = (value/total_pop) * 100)

pop_tidy_nowhite <- pop_tidy %>%
  filter(race != "White")

race_change_state <- ggplot(data = pop_tidy_nowhite, mapping = aes(x = year, y = normed, color = race)) +
  geom_line() +
  facet_wrap(~state) +
  theme_minimal() +
  scale_y_continuous(labels = scales::comma) +
  ggtitle("Total Population Change by Race, 1820 - 1990", subtitle = "by state") +
  xlab(NULL) +
  ylab(NULL)

race_change_state <- ggplot(data = pop_tidy_nowhite, mapping = aes(x = year, y = normed, color = race)) +
  geom_line() +
  facet_wrap(~state)

race_change_state_abs <- ggplot(data = pop_tidy_nowhite, mapping = aes(x = year, y = value, color = race)) +
  geom_line() +
  facet_wrap(~state)

```
### Total Population Change (1820-2020)
```{r}
pop_change
```
<br>

### Total Population Change by Race (1820-1990)
```{r}
race_change
race_change_state
```
<br>

## Race in the PNW Today (2020 Census Data)
Hover over the map to see population share values for each census tract!
```{r race_data, include = FALSE}
# retrieving variables from decennial census
# white, black, asian, native hawaiian / PI, native american / alaska native, hispanic, other

census_vars <- load_variables(2020, "pl")
v10 <- load_variables(2010, "pl")


race_vars <- data.frame(race = c("white", "black", "aina", "asian", "nhpi","other"), 
                        v20 = c("P1_003N",
                                     "P1_004N",
                                     "P1_005N",
                                     "P1_006N",
                                     "P1_007N",
                                     "P1_008N"),
                        v10 = c("P001003",
                                "P001004",
                                "P001005",
                                "P001006",
                                "P001007",
                                "P001008"))

ethnicity_vars <- data.frame(race = "hispanic", v20 = "P2_002N", v10 = "P002002")

# P1_002N summary var for race (total onerace pop)
# P2_001N summary var for Hispanic (total pop)

race_2020 <- tidycensus::get_decennial(geography = 'tract',
                                       geometry = TRUE,
                                       year = 2020,
                                       variables = race_vars$v20,
                                       summary_var = "P1_002N",
                                       state = c("OR", "WA", "ID"))
                           
ethn_2020 <- get_decennial(geography = "tract",
                          year = 2020,
                          geometry = TRUE,
                          variables = ethnicity_vars$v20,
                          summary_var = "P2_001N",
                          state = c("OR", "WA", "ID"))

#joining race names to the data
race_2020 <- left_join(race_2020, race_vars, by = c("variable" = "v20")) %>%
  select(1:7)


ethn_2020 <- ethn_2020 %>% mutate(race = "hispanic")

# binding race and ethnicity data together
re_2020 <- rbind(race_2020, ethn_2020)

# creating normalized data column
re_2020 <- re_2020 %>%
  mutate(normalized = value/summary_value * 100, digits = 2)

re_2020 <- data.frame(re_2020) %>%
  st_as_sf()

race_list <- unique(re_2020$race)

filt_df <- re_2020 %>%
  filter(race == "white")

for (r in race_list) {

  filt_df <- re_2020 %>%
    filter(race == r)

  map <- mapdeck(token = mb_token, style = mapdeck_style("dark"), zoom = 5, location = c(-118.16054641317953, 45.3390081860396)) %>%
    add_polygon(
      layer_id = "data-layer",
      data = filt_df,
      fill_colour = "normalized",
      fill_opacity = .6,
      legend = T,
      palette = "viridis",
      update_view = FALSE,
      legend_options = list(title = "Population (%)"),
      legend_format = list(fill_colour = as.integer),
      highlight_colour = "#80FFFFFF",
      tooltip = "normalized"
    )
  
  assign(paste0(r, "_map"), map, envir = .GlobalEnv)
}
```
### American Indian / Alaska Native
```{r}
aina_map
```
<br> 

### Asian
```{r}
asian_map
```
<br>

### Black
```{r}
black_map
```
<br>

### Native Hawaiian / Pacific Islander
```{r}
nhpi_map
```
<br>

### Hispanic / Latinx
```{r}
hispanic_map
```
<br>

### White
```{r}
white_map
```

## Language in the PNW (2020 Census)
```{r language_data, include = FALSE}
# total_vars <- data.frame(language = c(rep.int("spanish", 3),
#                                       rep.int("indo-eur", 3),
#                                       rep.int("asian-pi", 3),
#                                       rep.int("other", 3)),
#                          var = c("B16004_004",
#                                  "B16004_026",
#                                  "B16004_048",
#                                  "B16004_009",
#                                  "B16004_031",
#                                  "B16004_053",
#                                  "B16004_014",
#                                  "B16004_036",
#                                  "B16004_058",
#                                  "B16004_019",
#                                  "B16004_041",
#                                  "B16004_063"
#                                  ))
# 
# total_acs <- get_acs(geography = "tract",
#                      variables = total_vars$var,
#                      output = "tidy",
#                      state = c("OR", "WA", "ID"),
#                      geometry = TRUE,
#                      survey = "acs5",
#                      summary_var = "B16004_001")
# 
# # joining languages to variable names and then aggregating by language (bc tables currently separated by age group)
# lang_acs <- total_acs %>%
#   left_join(total_vars, by = c("variable" = "var")) %>%
#   group_by(language, GEOID, NAME) %>%
#   summarise(estimate = sum(estimate), moe = sum(moe), summary_est = first(summary_est)) %>%
#   mutate(est_share = estimate/summary_est * 100) # also adding normalized column
# 
# lang_acs <- data.frame(lang_acs) %>%
#   st_as_sf()
# 
# # MAPPING LANGUAGE
# # creating list of languages to loop through
# lang_list <- unique(lang_acs$language)
# 
# for (lang in lang_list) {
#   filt_df <- lang_acs %>%
#     filter(language == lang)
#   
#   map <- mapdeck(token = mb_token, style = mapdeck_style("dark"), zoom = 5, location = c(-118.16054641317953, 45.3390081860396)) %>%
#     add_polygon(
#       layer_id = "data-layer",
#       data = filt_df,
#       fill_colour = "est_share",
#       fill_opacity = .6,
#       legend = T,
#       palette = "magma",
#       update_view = FALSE,
#       legend_options = list(title = "Est. Population (%)"),
#       legend_format = list(fill_colour = as.integer),
#       highlight_colour = "#70FFFFFF",
#       tooltip = "est_share"
#     )
#    
#   assign(paste0(gsub("-", "", lang), "_map"), map, envir = .GlobalEnv)
# }
```

### Farm Labor in the PNW
```{r}

### HIRED LABOR
hired <- read.csv("data/raw/hiredlabor_1992to2017.csv")
# removing commas from value column and converting to numeric
hired$Value <- as.numeric(gsub(",", "", hired$Value))

# summarising to find averages of the monthly data 
hired_avg <- hired %>%
  group_by(State, Year) %>%
  summarise(value = mean(Value))

hired_avg$value <- as.integer(hired_avg$value)

hired_labor <- ggplot(data = hired_avg) +
  geom_line(mapping = aes(x = Year, y = value, color = State)) +
  theme_minimal() +
  scale_y_continuous(labels = scales::comma) +
  ggtitle("Hired Farm Labor, 1991 - 2017") +
  xlab("year") +
  ylab("number of")
  

# hired labor by county
hired_county <- read.csv("data/raw/hiredlabor_county_2002to2017.csv")
hired_county$Value <- as.numeric(gsub(",", "", hired_county$Value))

hired_county$County.ANSI <- formatC(hired_county$County.ANSI, width = 3, flag = "0")
hired_county$GEOID <- paste0(hired_county$State.ANSI, hired_county$County.ANSI)

hired_county_17 <- hired_county %>%
  filter(Year == 2017) 

pnw_counties <- counties(state = c("OR", "WA", "ID"))
hired_county_17$County.ANSI <- formatC(hired_county_17$County.ANSI, width = 3, flag = "0")
hired_county_17$GEOID <- paste0(hired_county_17$State.ANSI, hired_county_17$County.ANSI)

hired_county_17 <- left_join(hired_county_17, pnw_counties["GEOID"]) %>%
  st_as_sf()

total_pop_county <- get_decennial(geography = "county",
                                  state = c("OR", "WA", "ID"),
                                  sumfile = "pl",
                                  year = 2020, 
                                  variable = "P1_001N") 

colnames(hired_county_17)

hired_county_17 <- left_join(hired_county_17, total_pop_county[c("GEOID", "value")]) %>%
  mutate(normed = (Value/value) * 100)

hired_county_map <- mapdeck(token = mb_token, style = mapdeck_style("dark"), zoom = 5, location = c(-118.16054641317953, 45.3390081860396)) %>%
    add_polygon(
      layer_id = "data-layer",
      data = hired_county_17,
      fill_colour = "normed",
      fill_opacity = .6,
      legend = T,
      palette = "magma",
      update_view = FALSE,
      legend_options = list(title = "Est. Population (%)"),
      legend_format = list(fill_colour = as.integer),
      highlight_colour = "#70FFFFFF",
      tooltip = "normed"
    )

### MIGRANT LABOR
mig_labor <- read.csv("data/raw/migrantlabor_2002to2017.csv")
mig_labor$Value <- as.numeric(gsub(",", "", mig_labor$Value))

# joining to hired labor data to get a sense of * as share of hired labor *
mig_labor <- mig_labor %>%
  left_join(hired_avg) %>%
  mutate(normed = (Value / value) * 100)


mig_labor_abs <- ggplot(data = mig_labor, aes(x = Year, y = Value, color = State)) +
  geom_line() +
  geom_point() +
  theme_minimal() +
  scale_y_continuous(labels = scales::comma) +
  ggtitle("Migrant Labor in the PNW, 2012-2017") +
  xlab(NULL) +
  ylab("number of workers")
  
mig_labor_share <- ggplot(data = mig_labor, aes(x = Year, y = normed, color = State)) +
  geom_line() +
  geom_point() +
  theme_minimal() +
  scale_y_continuous(labels = scales::comma) +
  ggtitle("Migrant Labor in the PNW, 2012-2017", subtitle = "as share of farm workforce") +
  xlab(NULL) +
  ylab("percent of hired labor")

# MAPPING MIGRANT LABOR
mig_county <- read.csv("data/raw/migrant_labor_county_2012to2017.csv") %>%
  select(c(2, 6:7, 10:11, 20))

mig_county$Value <- gsub(",", "", mig_county$Value)

# pivoting wide to get cross-year comparison
# mig_county <- pivot_wider(data = mig_county,
#                           names_from = Year, 
#                           values_from = Value)

# mig_county[is.na(mig_county)] <- "0"
# mig_county[mig_county$`2012` == " (D)", "2012"] <- NA
# mig_county[mig_county$`2017` == " (D)", "2017"] <- NA

# mig_county$`2012` <- as.integer(mig_county$`2012`)
# mig_county$`2017` <- as.integer(mig_county$`2017`)


mig_county$County.ANSI <- formatC(mig_county$County.ANSI, width = 3, flag = "0")
mig_county$GEOID <- paste0(mig_county$State.ANSI, mig_county$County.ANSI)


# joining to hired labor data
mig_county <- left_join(mig_county, hired_county, by = c("Year", "GEOID")) 

mig_county <- mig_county %>% select(c(year = "Year", state = "State.x", county = "County.x", "GEOID", mig_labor = "Value.x", hired_labor = "Value.y"))

mig_county[mig_county$mig_labor == " (D)", "mig_labor"] <- NA
mig_county$mig_labor <- as.integer(mig_county$mig_labor)

mig_county <- mig_county %>%
  mutate(normed = (mig_labor/hired_labor) * 100)

mig_county <- left_join(mig_county, pnw_counties["GEOID"]) %>%
  st_as_sf()


#filtering 2017
mig_county_17 <- mig_county %>%
  filter(year == 2017)

mig_county_map <- mapdeck(token = mb_token, style = mapdeck_style("dark"), zoom = 5, location = c(-118.16054641317953, 45.3390081860396)) %>%
    add_polygon(
      layer_id = "data-layer",
      data = mig_county_17,
      fill_colour = "normed",
      fill_opacity = .6,
      legend = T,
      palette = "magma",
      update_view = FALSE,
      legend_options = list(title = "Est. Population (%)"),
      legend_format = list(fill_colour = as.integer),
      highlight_colour = "#70FFFFFF",
      tooltip = "normed"
    )

mig_county_17$lon <- st_coordinates(st_geometry(mig_county_17))["X"]
mig_county_17$lat <- st_coordinates(st_geometry(mig_county_17))["Y"]
```
```{r}
hired_labor
mig_labor_abs
mig_labor_share
```
<br>

### Geographic Distribution of Hired Farm Labor
```{r}
hired_county_map
```
<br>

### Geographic Distribution of Migrant Labor
```{r}
mig_county_map
```